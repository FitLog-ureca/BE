<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ureca.fitlog.todos.mapper.TodoMapper">
    <!-- 특정 날짜 + 운동 종목의 현재 세트 개수 조회 -->
    <select id="countSetsByDateAndExercise" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM todos
        WHERE date = #{date}
          AND exercise_id = #{exerciseId}
          AND user_id = #{userId};
    </select>

    <!-- 투두 생성 -->
    <insert id="insertTodo"
            parameterType="com.ureca.fitlog.todos.dto.request.TodoInsertDTO"
            useGeneratedKeys="true"
            keyProperty="todoId">
        INSERT INTO todos (
            user_id,
            workout_id,
            exercise_id,
            date,
            sets_number,
            reps_target,
            weight,
            rest_time
        ) VALUES (
                     #{userId},
                     #{workoutId},
                     #{exerciseId},
                     #{date},
                     #{setsNumber},
                     #{repsTarget},
                     #{weight},
                     #{restTime}
                 )
    </insert>

    <select id="findBaseInfoByTodoId" resultType="map">
        SELECT date, exercise_id
        FROM todos
        WHERE todo_id = #{todoId}
          AND user_id = #{userId}
    </select>

    <select id="findMaxSetsNumberByTodoId" resultType="int">
        SELECT MAX(sets_number)
        FROM todos
        WHERE date = (SELECT date FROM todos WHERE todo_id = #{todoId})
          AND exercise_id = (SELECT exercise_id FROM todos WHERE todo_id = #{todoId})
          AND user_id = #{userId};
    </select>

    <select id="findNearestBaseTodoId" resultType="long">
        <![CDATA[
        SELECT MAX(t.todo_id)
        FROM todos t
        WHERE t.user_id = #{userId}
        AND t.sets_number = 1
        AND t.todo_id <= #{todoId}
        AND t.exercise_id = (
            SELECT exercise_id FROM todos WHERE todo_id = #{todoId}
        )
        AND t.date = (
            SELECT date FROM todos WHERE todo_id = #{todoId}
            )
        ]]>
    </select>

    <select id="findMaxSetsNumberInWorkoutRange" resultType="int">
    <![CDATA[
        SELECT COALESCE(MAX(t.sets_number), 1)
        FROM todos t
        WHERE t.user_id = #{userId}
          AND t.date = (
            SELECT date FROM todos WHERE todo_id = #{baseTodoId}
            )
                                     AND t.exercise_id = (
        SELECT exercise_id FROM todos WHERE todo_id = #{baseTodoId}
            )
                                        AND t.todo_id >= #{baseTodoId}
                                        AND t.todo_id < (
        SELECT COALESCE(
            MIN(t2.todo_id),
            999999999
            )
        FROM todos t2
        WHERE t2.user_id = t.user_id
          AND t2.date = t.date
          AND t2.exercise_id = t.exercise_id
          AND t2.sets_number = 1
          AND t2.todo_id > #{baseTodoId}
            )
        ]]>
</select>

    <!-- 투두 완료 체크 (userId 검증 포함) -->
    <select id="getIsCompletedById" resultType="boolean">
        SELECT is_completed
        FROM todos
        WHERE todo_id = #{todoId}
          AND user_id = #{userId};
    </select>

    <!-- 투두 완료 상태 업데이트 (userId 검증 포함) -->
    <update id="updateTodoCompletion">
        UPDATE todos
        SET is_completed = IFNULL(#{isCompleted}, FALSE),
            updated_at = CURRENT_TIMESTAMP
        WHERE todo_id = #{todoId}
          AND user_id = #{userId};
    </update>

    <!-- 투두 reps_target만 수정 (userId 검증 포함) -->
    <update id="updateTodoRepsOnly" parameterType="map">
        UPDATE todos
        SET reps_target = #{repsTarget},
            updated_at = CURRENT_TIMESTAMP
        WHERE todo_id = #{todoId}
          AND user_id = #{userId};
    </update>

    <!-- 투두 reps_target, weight 수정 (userId 검증 포함) -->
    <update id="updateTodoRecord">
        UPDATE todos
        SET
            reps_target = COALESCE(#{repsTarget}, reps_target),
            weight      = COALESCE(#{weight}, weight),
            updated_at  = CURRENT_TIMESTAMP
        WHERE todo_id = #{todoId}
          AND user_id = #{userId};
    </update>

    <!-- 특정 todo_id 삭제 (userId 검증 포함) -->
    <delete id="deleteTodoById" parameterType="map">
        DELETE FROM todos
        WHERE todo_id = #{todoId}
          AND user_id = #{userId};
    </delete>

    <!-- 특정 workout_id 삭제 -->
    <delete id="deleteByWorkoutId">
        DELETE FROM todos
        WHERE workout_id = #{workoutId}
          AND user_id = #{userId}
    </delete>

    <!-- 삭제 대상 조회 (workout_id + sets_number) -->
    <select id="findWorkoutIdAndSetNumberByTodoId" resultType="map">
        SELECT workout_id, sets_number
        FROM todos
        WHERE todo_id = #{todoId}
          AND user_id = #{userId}
    </select>

    <!-- workout_id 기준 재정렬 (ROW_NUMBER 방식) -->
    <update id="reorderSetsByWorkoutId">
        UPDATE todos t
            JOIN (
            SELECT
            todo_id,
            ROW_NUMBER() OVER (ORDER BY sets_number ASC, todo_id ASC) AS new_number
            FROM todos
            WHERE workout_id = #{workoutId}
            AND user_id = #{userId}
            ) r ON t.todo_id = r.todo_id
            SET t.sets_number = r.new_number
        WHERE t.user_id = #{userId}
    </update>

    <!-- 하루 완료 버튼(is_done) 업데이트 (userId 필터링) -->
    <update id="updateTodosDoneStatus">
        UPDATE todos
        SET is_done = IFNULL(#{isDone}, FALSE),
            updated_at = CURRENT_TIMESTAMP
        WHERE date = #{date}
          AND user_id = #{userId};
    </update>

    <!-- 특정 날짜에 is_done = TRUE인 투두 존재 여부 확인 (userId 필터링) -->
    <select id="existsTodosDoneTrueByDate"
            parameterType="map"
            resultType="int">
        SELECT COUNT(*)
        FROM todos
        WHERE date = #{date}
          AND user_id = #{userId}
          AND is_done = TRUE;
    </select>

    <!-- 휴식 시간 기록 및 초기화 -->
    <update id="updateRestTime" parameterType="map">
        UPDATE todos
        SET rest_time = #{restTime},
            updated_at = CURRENT_TIMESTAMP
        WHERE todo_id = #{todoId}
          AND user_id = #{userId};
    </update>

    <update id="resetRestTime" parameterType="map">
        UPDATE todos
        SET rest_time = NULL,
            updated_at = CURRENT_TIMESTAMP
        WHERE todo_id = #{todoId}
          AND user_id = #{userId};
    </update>

    <!-- 참고용 통계 (userId 필터링 추가) -->
    <select id="countTodosByDate" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM todos
        WHERE date = #{date}
          AND user_id = #{userId};
    </select>

    <select id="countTodosByDateAndNotCompleted" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM todos
        WHERE date = #{date}
          AND user_id = #{userId}
          AND (is_completed IS NULL OR is_completed = FALSE);
    </select>

    <!-- workout_id 업데이트 (운동 항목 생성 직후) -->
    <update id="updateWorkoutId">
        UPDATE todos
        SET workout_id = #{workoutId}
        WHERE todo_id = #{todoId}
          AND user_id = #{userId}
    </update>

    <!-- 세트 추가용 쿼리들 -->
    <select id="findWorkoutIdByTodoId" resultType="long">
        SELECT workout_id
        FROM todos
        WHERE todo_id = #{todoId}
          AND user_id = #{userId}
    </select>

    <select id="findMaxSetsNumberByWorkoutId" resultType="int">
        SELECT COALESCE(MAX(sets_number), 0)
        FROM todos
        WHERE workout_id = #{workoutId}
          AND user_id = #{userId}
    </select>

    <!-- 달력 요약 -->
    <select id="findDailySummaryByDateRange"
            resultType="com.ureca.fitlog.todos.dto.response.TodoDailySummaryDTO">
        <![CDATA[
        SELECT
            date AS date,
            COUNT(*) AS totalSets,
            SUM(CASE WHEN is_completed = TRUE THEN 1 ELSE 0 END) AS completedSets,
            MAX(is_done) AS isDone
        FROM todos
        WHERE user_id = #{userId}
          AND date >= #{startDate}
          AND date < #{endDate}
        GROUP BY date
        ORDER BY date ASC
        ]]>
    </select>
</mapper>