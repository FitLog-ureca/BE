<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ureca.fitlog.exercise.mapper.ExerciseMapper">

    <!-- 완료된 운동 목록 + 항목별 칼로리 -->
    <select id="findCompletedExercisesByDate"
            parameterType="java.time.LocalDate"
            resultType="com.ureca.fitlog.exercise.dto.ExerciseResponseDTO$ExerciseItem">
        SELECT
            t.todo_id AS todoId,
            t.exercise_id AS exerciseId,
            e.name AS exerciseName,
            t.sets_number AS setsNumber,
            t.reps_target AS repsTarget,
            t.rest_time AS restTime,
            t.is_completed AS isCompleted,
            e.default_calories_per_set AS caloriesPerRep,
            (t.reps_target * e.default_calories_per_set) AS burnedCalories
        FROM todos t
                 JOIN exercises e ON t.exercise_id = e.exercise_id
        WHERE t.date = #{date}
        ORDER BY t.todo_id ASC
    </select>

    <!-- 계획(미완료) 운동 목록 -->
    <select id="findPlannedExercisesByDate"
            parameterType="java.time.LocalDate"
            resultType="com.ureca.fitlog.exercise.dto.ExerciseResponseDTO$ExerciseItem">
        SELECT
            t.todo_id AS todoId,
            t.exercise_id AS exerciseId,
            e.name AS exerciseName,
            t.sets_number AS setsNumber,
            t.reps_target AS repsTarget,
            t.rest_time AS restTime,
            t.is_completed AS isCompleted
        FROM todos t
                 JOIN exercises e ON t.exercise_id = e.exercise_id
        WHERE t.date = #{date}
        ORDER BY t.todo_id ASC
    </select>

    <!-- 해당 날짜 총 소모 칼로리 -->
    <select id="findTotalCaloriesByDate"
            parameterType="java.time.LocalDate"
            resultType="double">
        SELECT IFNULL(SUM(t.reps_target * e.default_calories_per_set), 0)
        FROM todos t
                 JOIN exercises e ON t.exercise_id = e.exercise_id
        WHERE t.date = #{date}
          AND t.is_completed = TRUE
    </select>

    <!-- 운동 종목 전체 조회/검색 (드롭다운/리스트용) -->
    <select id="findExercises"
            resultType="com.ureca.fitlog.exercise.dto.ExerciseListResponseDTO$ExerciseList">
        SELECT
        exercise_id AS exerciseId,
        name AS name,
        default_calories_per_set AS defaultCaloriesPerSet,
        unit AS unit
        FROM exercises
        <where>
            <if test="keyword != null and keyword != ''">
                name LIKE CONCAT('%', #{keyword}, '%')
            </if>
        </where>
        ORDER BY name ASC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 전체 개수 조회 -->
    <select id="countExercises" resultType="int">
        SELECT COUNT(*)
        FROM exercises
        <where>
            <if test="keyword != null and keyword != ''">
                name LIKE CONCAT('%', #{keyword}, '%')
            </if>
        </where>
    </select>

</mapper>
